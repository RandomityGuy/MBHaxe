# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
orbs:
    android: circleci/android@2.3.0 # The Windows orb give you everything you need to start using the Windows executor.
# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  build:
    executor: 
        name: android/android-machine
        shell: bash.exe # executor type
        tag: 2021.10.1
    # Checkout the code as the first step. This is a dedicated CircleCI step.
    # The python orb's install-packages step will install the dependencies from a Pipfile via Pipenv by default.
    # Here we're making sure we use just use the system-wide pip. By default it uses the project root's requirements.txt.
    # Then run your tests!
    # CircleCI will report the results back to your VCS provider.
    steps:
        - add_ssh_keys:
            fingerprints:
                - "82:42:56:a0:57:43:95:4e:00:c0:8c:c1:7f:70:74:47"
  
        - checkout:
            path: ~/MBHaxe
        - run:
            name: Install dependencies
            command: |
              set -eux
              download_url="https://github.com/HaxeFoundation/haxe/releases/download/4.3.3/haxe-4.3.3-linux64.tar.gz"
              echo "Downloading [$download_url]..."
              mkdir /tmp/haxe
              curl -fsSL --retry 3 --retry-delay 5 "$download_url" -o /tmp/haxe.tar.gz
              tar xzvf /tmp/haxe.tar.gz -C /tmp/haxe --strip-components=1
              export PATH=/tmp/haxe/:"$PATH"
              export HAXE_STD_PATH=/tmp/haxe/std
              haxelib setup ~/haxelib
              haxelib list
        - android/install-ndk: 
            version: 18.1.5063045
        - run:
            name: Install haxe dependencies
            command: |
              export PATH=/tmp/haxe/:"$PATH"
              export HAXE_STD_PATH=/tmp/haxe/std
              haxelib git heaps https://github.com/RandomityGuy/heaps
              haxelib dev hlopenal ~/deps/hashlink/libs/openal
              haxelib dev hlsdl ~/deps/hashlink/libs/sdl
        - run:
            name: Compile MBHaxe
            command: |
              export PATH=/tmp/haxe/haxe:"$PATH"
              export HAXE_STD_PATH=/tmp/haxe/haxe/std
              cd ~/MBHaxe
              git clone https://github.com/RandomityGuy/MBHaxeAndroidLibs


# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  build-android:
    jobs:
      - build:
          filters:
            tags:
              only: /^\d+.\d+.\d+$/
